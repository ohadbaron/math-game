<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מלחמת הכוכבים</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        body {
            background-color: #0d1117;
            color: #e6edf3;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        canvas {
            background-color: #000;
            display: block;
        }

        #game-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
            background-color: rgba(40, 44, 52, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }
        
        #game-ui h1 {
            font-size: 3em;
            color: #ffc107;
            text-shadow: 0 0 10px #ffc107;
            animation: pulse 2s infinite;
        }

        #game-ui p {
            font-size: 1.2em;
            color: #d1d1d1;
        }
        
        .button {
            padding: 12px 24px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        
        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.4);
        }

        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.7s ease;
            transform: translate(-50%, -50%) rotate(45deg);
            z-index: 0;
        }
        
        .button:hover::before {
            width: 0;
            height: 0;
        }
        
        #game-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex; /* Now always visible */
            z-index: 10;
        }
        
        #exitButton {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e74c3c;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #exitButton:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }
        
        #exitButton:active {
            transform: scale(1);
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.4);
        }
        
        #exitButton svg {
            fill: #fff;
            width: 30px;
            height: 30px;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        #score-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            color: #ffc107;
            text-shadow: 2px 2px 4px #000;
        }
        
        /* Responsive styles for smaller screens */
        @media (max-width: 600px) {
            #game-ui h1 {
                font-size: 2em;
            }
            #game-ui p {
                font-size: 1em;
            }
            .button {
                padding: 10px 20px;
                font-size: 1em;
            }
            #score-display {
                font-size: 1.5em;
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="game-ui">
            <div id="start-screen">
                <h1>מלחמת הכוכבים</h1>
                <p>השתמשו בחצים או בנגיעה במסך כדי להזיז את החללית ולהשמיד את האסטרואידים!</p>
                <button id="startButton" class="button">התחל משחק</button>
            </div>
            <div id="game-over-screen" style="display:none;">
                <h1>המשחק נגמר!</h1>
                <p id="finalScore">הניקוד שלך: 0</p>
                <button id="restartButton" class="button">שחק שוב</button>
            </div>
        </div>
        <div id="game-controls">
            <div id="exitButton" title="יציאה למסך ראשי">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </div>
        </div>
        <span id="score-display">ניקוד: 0</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            const startButton = document.getElementById('startButton');
            const restartButton = document.getElementById('restartButton');
            const exitButton = document.getElementById('exitButton');
            const startScreen = document.getElementById('start-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            const gameUI = document.getElementById('game-ui');
            const gameControls = document.getElementById('game-controls');
            const finalScoreElement = document.getElementById('finalScore');
            const scoreDisplay = document.getElementById('score-display');
            
            let game;
            
            class Game {
                constructor() {
                    this.ship = new Ship();
                    this.asteroids = [];
                    this.lasers = [];
                    this.explosions = []; 
                    this.score = 0;
                    this.isGameOver = false;
                    this.lastSpawnTime = 0;
                    this.spawnInterval = 900;
                    this.touchMoveX = 0;
                    // --- Add new variables for speed management ---
                    this.speedMultiplier = 1.0; // Initial speed multiplier
                    this.nextSpeedIncreaseScore = 250; // The next score at which the speed will increase
                }

                init() {
                    this.ship = new Ship();
                    this.asteroids = [];
                    this.lasers = [];
                    this.explosions = []; 
                    this.score = 0;
                    this.isGameOver = false;
                    this.lastSpawnTime = 0;
                    this.spawnInterval = 900; // Reset enemy spawn interval
                    this.speedMultiplier = 1.0; // Reset speed multiplier
                    this.nextSpeedIncreaseScore = 250; // Reset score threshold
                    this.updateScoreDisplay();
                    this.gameLoop();
                }

                gameLoop(timestamp) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    this.update(timestamp);
                    this.draw();
                    
                    if (this.isGameOver && this.explosions.length === 0) {
                        this.showGameOverScreen();
                        return; 
                    }
                    
                    requestAnimationFrame(this.gameLoop.bind(this));
                }

                update(timestamp) {
                    if (!this.isGameOver) {
                        this.ship.update();
                    
                        if (timestamp - this.lastSpawnTime > this.spawnInterval) {
                            this.spawnAsteroid();
                            this.lastSpawnTime = timestamp;
                        }
                    
                        this.updateAsteroids();
                        this.updateLasers();
                        this.checkCollisions();
                    }
                    
                    this.updateExplosions(); 
                }
                
                draw() {
                    this.ship.draw();
                    this.asteroids.forEach(a => a.draw());
                    this.lasers.forEach(l => l.draw());
                    this.explosions.forEach(e => e.draw()); 
                }

                spawnAsteroid() {
                    const x = Math.random() * canvas.width;
                    const y = -50;
                    const size = Math.random() * 30 + 20;
                    // --- Use the speed multiplier to determine asteroid speed ---
                    const speedY = (Math.random() * 2 + 1) * this.speedMultiplier;
                    this.asteroids.push(new Asteroid(x, y, size, speedY));
                }

                updateAsteroids() {
                    this.asteroids = this.asteroids.filter(a => a.y < canvas.height + 50);
                    this.asteroids.forEach(a => a.update());
                }
                
                updateLasers() {
                    this.lasers = this.lasers.filter(l => l.y > -10);
                    this.lasers.forEach(l => l.update());
                }

                updateExplosions() {
                    this.explosions = this.explosions.filter(e => e.isAlive());
                    this.explosions.forEach(e => e.update());
                }

                checkCollisions() {
                    this.lasers.forEach((laser, lIndex) => {
                        this.asteroids.forEach((asteroid, aIndex) => {
                            if (this.isColliding(laser, asteroid)) {
                                this.lasers.splice(lIndex, 1);
                                this.asteroids.splice(aIndex, 1);
                                this.score += 10;
                                this.updateScoreDisplay();
                            }
                        });
                    });
                    
                    this.asteroids.forEach(asteroid => {
                        if (this.isColliding(this.ship, asteroid)) {
                            this.isGameOver = true;
                            this.explosions.push(new Explosion(this.ship.x, this.ship.y));
                            this.ship.x = -100;
                            this.ship.y = -100;
                        }
                    });
                }
                
                isColliding(obj1, obj2) {
                    const dx = obj1.x - obj2.x;
                    const dy = obj1.y - obj2.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    return distance < obj1.radius + obj2.radius;
                }
                
                showGameOverScreen() {
                    finalScoreElement.textContent = `הניקוד שלך: ${this.score}`;
                    gameUI.style.display = 'flex';
                    gameOverScreen.style.display = 'flex';
                    startScreen.style.display = 'none';
                }
                
                updateScoreDisplay() {
                    scoreDisplay.textContent = `ניקוד: ${this.score}`;
                    // --- Logic for increasing speed ---
                    if (this.score >= this.nextSpeedIncreaseScore) {
                        this.speedMultiplier += 0.15; // Increase speed by 15%
                        this.spawnInterval = Math.max(250, this.spawnInterval * 0.92); // Decrease the wait time between asteroids
                        this.nextSpeedIncreaseScore += 250; // Set the next score threshold
                    }
                }
            }

            class Ship {
                constructor() {
                    this.x = canvas.width / 2;
                    this.y = canvas.height - 50;
                    this.radius = 30;
                    this.speed = 10;
                }

                update() {
                    if (this.x !== game.touchMoveX && game.touchMoveX !== 0) {
                        this.x += (game.touchMoveX - this.x) * 0.1;
                    }
                }

                draw() {
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y - this.radius);
                    ctx.lineTo(this.x - this.radius, this.y + this.radius);
                    ctx.lineTo(this.x + this.radius, this.y + this.radius);
                    ctx.closePath();
                    ctx.fillStyle = '#1e90ff';
                    ctx.shadowColor = '#1e90ff';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                
                fireLaser() {
                    game.lasers.push(new Laser(this.x, this.y - this.radius));
                }
            }

            class Asteroid {
                constructor(x, y, radius, speedY) {
                    this.x = x;
                    this.y = y;
                    this.radius = radius;
                    this.speedY = speedY;
                    this.rotation = 0;
                    this.rotationSpeed = Math.random() * 0.05 - 0.025;
                }
                
                update() {
                    this.y += this.speedY;
                    this.rotation += this.rotationSpeed;
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.beginPath();
                    ctx.moveTo(this.radius, 0);
                    for (let i = 0; i < 7; i++) {
                        ctx.rotate(Math.PI * 2 / 7);
                        if (i % 2 === 0) {
                            ctx.lineTo(this.radius * 0.7, 0);
                        } else {
                            ctx.lineTo(this.radius, 0);
                        }
                    }
                    ctx.closePath();
                    ctx.fillStyle = '#8B4513';
                    ctx.shadowColor = '#654321';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.restore();
                }
            }

            class Laser {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.width = 4;
                    this.height = 20;
                    this.radius = Math.max(this.width, this.height) / 2;
                    this.speed = 15;
                }
                
                update() {
                    this.y -= this.speed;
                }
                
                draw() {
                    ctx.fillStyle = '#ff0000';
                    ctx.shadowColor = '#ff3333';
                    ctx.shadowBlur = 15;
                    ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
                    ctx.shadowBlur = 0;
                }
            }

            class Explosion {
                constructor(x, y) {
                    this.particles = [];
                    this.lifetime = 100;
                    this.frame = 0;
                    for (let i = 0; i < 40; i++) {
                        this.particles.push(new Particle(x, y));
                    }
                }

                update() {
                    this.frame++;
                    this.particles.forEach(p => p.update());
                }

                draw() {
                    this.particles.forEach(p => p.draw());
                }

                isAlive() {
                    return this.frame < this.lifetime;
                }
            }

            class Particle {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.radius = Math.random() * 4 + 2;
                    this.velocity = {
                        x: (Math.random() - 0.5) * 8,
                        y: (Math.random() - 0.5) * 8
                    };
                    this.alpha = 1;
                    this.hue = Math.random() * 60;
                }

                update() {
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.alpha -= 0.02;
                }

                draw() {
                    ctx.save();
                    ctx.globalAlpha = Math.max(0, this.alpha);
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `hsl(${this.hue}, 100%, 50%)`;
                    ctx.fill();
                    ctx.restore();
                }
            }

            const startGame = () => {
                gameUI.style.display = 'none';
                startScreen.style.display = 'none';
                gameOverScreen.style.display = 'none';
                
                game = new Game();
                game.init();
            };
            
            const resizeCanvas = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                if (game && game.ship) {
                    game.ship.x = canvas.width / 2;
                    game.ship.y = canvas.height - 50;
                }
            };
            
            const goToMainMenu = () => {
                // This function is now correctly linked to the exit button
                window.location.href = '../index.html';
            };

            // Event listeners
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
            exitButton.addEventListener('click', goToMainMenu);

            // Handle keyboard input
            window.addEventListener('keydown', (e) => {
                if (game && !game.isGameOver) {
                    if (e.key === 'ArrowLeft') {
                        game.ship.x -= game.ship.speed;
                    } else if (e.key === 'ArrowRight') {
                        game.ship.x += game.ship.speed;
                    } else if (e.key === ' ') {
                        game.ship.fireLaser();
                    }
                }
            });

            // Handle touch input
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (game && !game.isGameOver) {
                    const touchX = e.touches[0].clientX;
                    game.touchMoveX = touchX;
                }
            });
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (game && !game.isGameOver) {
                    const touchX = e.touches[0].clientX;
                    game.touchMoveX = touchX;
                    game.ship.fireLaser();
                }
            });

            // Handle mouse input
            canvas.addEventListener('mousemove', (e) => {
                if (game && !game.isGameOver) {
                    game.ship.x = e.clientX;
                }
            });
            
            canvas.addEventListener('click', (e) => {
                if (game && !game.isGameOver) {
                    game.ship.fireLaser();
                }
            });

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        });
    </script>
</body>
</html>
