<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>תרגילי חשבון</title>
    <style>
        body {
            font-family: "Arial Hebrew", "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        h1 {
            color: #2e8b57;
            margin-bottom: 20px;
        }
        .game-container {
            margin-top: 20px;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls-top {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .vertical-math {
            font-size: 24px;
            margin: 20px auto;
            display: inline-block;
            direction: ltr; /* Math problems are LTR */
        }
        .math-row {
            display: flex;
            justify-content: flex-end; /* Align numbers to the right */
            width: 100%; /* Ensure row takes full width for alignment */
        }
        .math-cell, .math-input {
            width: 45px; /* Slightly larger for better touch */
            height: 45px;
            margin: 1px;
            font-size: 22px;
            text-align: center;
            vertical-align: middle;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            border-radius: 5px; /* Rounded corners for cells/inputs */
        }
        .math-cell {
            border: 1px solid #aaa;
            background-color: #f9f9f9;
        }
        .math-input {
            border: 1px solid #ccc;
            background-color: #fff;
        }
        .math-cell.empty {
            border: none;
            background-color: transparent;
        }
        .separator-line {
            border-top: 2px solid black;
            height: 2px;
        }
        button {
            font-size: 16px; /* Slightly smaller for more buttons */
            padding: 10px 15px;
            background-color: #2e8b57;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #246b44;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .feedback {
            font-size: 20px;
            margin-top: 15px;
            min-height: 28px;
            font-weight: bold;
        }
        .score {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        .correct {
            background-color: #c8f7c5;
        }
        .incorrect {
            background-color: #f7c5c5;
        }

        /* Specific styles for long division layout */
        .long-division-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align content to the left within the container */
            font-size: 24px;
            margin: 20px auto;
            direction: ltr; /* Ensure LTR for numbers */
            padding: 10px;
            border: 1px solid #ddd; /* Light border around the whole division problem */
            border-radius: 8px;
            background-color: #fdfdfd;
            width: auto; /* Adjust width based on content */
            min-width: 250px; /* Minimum width to prevent squishing */
        }

        .division-quotient-row {
            display: flex;
            justify-content: flex-start; /* Aligns quotient digits from the left */
            width: 100%;
            margin-bottom: 5px;
        }

        .division-problem-line {
            display: flex;
            align-items: flex-end; /* Align divisor to the bottom of its cell */
            position: relative; /* For the top line of the division symbol */
            margin-bottom: 5px;
            width: 100%;
        }

        .division-problem-line::before {
            content: '';
            position: absolute;
            top: 0;
            /* Dynamically set left and width in JS for precise alignment */
            border-top: 2px solid black;
        }

        .division-divisor-display {
            width: 50px; /* Fixed width for divisor */
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-right: 2px solid black; /* Right side of division bracket */
            padding-right: 5px;
        }

        .division-dividend-display {
            display: flex;
            justify-content: flex-start; /* Dividend digits are left-aligned within their container */
            padding-left: 5px;
            min-width: 100px; /* Ensure space for dividend */
        }
        .division-dividend-display .math-cell {
            border: 1px solid #aaa; /* Add borders to dividend digits */
            background-color: #f9f9f9;
        }

        .division-step-row {
            display: flex;
            justify-content: flex-start; /* Align intermediate numbers to the left of their section */
            width: 100%;
            box-sizing: border-box;
        }

        .division-step-row.subtraction-line {
            border-top: 1px solid black;
            margin-top: 5px;
            padding-top: 5px;
        }

        .division-cell-display, .division-step-input { /* Combined styles for display and input cells in division */
            width: 45px;
            height: 45px;
            margin: 1px;
            font-size: 22px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            border-radius: 5px;
        }
        .division-cell-display {
            background-color: #f9f9f9; /* Same as math-cell for consistency */
            border: 1px solid #aaa;
        }
        .division-step-input {
            border: 1px solid #ccc;
            background-color: #fff;
        }
        .division-cell-display.empty {
            border: none;
            background-color: transparent;
        }

        .quotient-digit-input {
            width: 45px;
            height: 45px;
            font-size: 22px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 1px;
        }
        .remainder-row {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            margin-top: 15px;
        }
        .remainder-label {
            font-size: 20px;
            color: #333;
            font-weight: bold;
            margin-right: 10px;
        }
        .remainder-input {
            width: 80px; /* Wider for remainder */
            height: 45px;
            font-size: 22px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>תרגילי חשבון</h1>
    <div class="game-container">
        <div class="controls-top">
            <button id="new-addition-button">תרגיל חיבור חדש</button>
            <button id="new-subtraction-button">תרגיל חיסור חדש</button>
            <button id="new-multiplication-button">תרגיל כפל חדש</button>
            <button id="new-division-button">תרגיל חילוק חדש</button>
        </div>
        <div class="vertical-math" id="math-problem-container">
            <p>בחר סוג תרגיל כדי להתחיל!</p>
        </div>
        <button id="check-answer-button">בדוק תשובה</button>
        <div class="feedback" id="feedback"></div>
        <div class="score" id="score">ניקוד: 0</div>
    </div>

    <script>
        let num1 = 0;
        let num2 = 0;
        let expectedPartialRows = []; // For multiplication
        let currentOperation = ''; // 'addition', 'subtraction', 'multiplication', 'division'
        let score = 0;
        let currentProblemChecked = false; // To prevent multiple scoring per problem

        const mathProblemContainer = document.getElementById('math-problem-container');
        const feedbackEl = document.getElementById('feedback');
        const scoreDisplay = document.getElementById('score');
        const checkAnswerButton = document.getElementById('check-answer-button');

        // --- Utility Functions ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function clearFeedback() {
            feedbackEl.textContent = '';
            feedbackEl.classList.remove('correct', 'incorrect');
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = `ניקוד: ${score}`;
        }

        function markInput(inputElement, isCorrect) {
            // Do not mark memory boxes or brought-down digits
            if (inputElement.id.startsWith('mem-') || inputElement.classList.contains('brought-down-digit')) {
                inputElement.classList.remove('correct', 'incorrect');
                return;
            }
            if (isCorrect) {
                inputElement.classList.add('correct');
                inputElement.classList.remove('incorrect');
            } else {
                inputElement.classList.add('incorrect');
                inputElement.classList.remove('correct');
            }
        }

        // Function to pad numbers with leading empty cells for alignment
        function padNumberForDisplay(numStr, totalLength) {
            let padding = totalLength - numStr.length;
            let html = '';
            for (let i = 0; i < padding; i++) {
                html += `<div class="math-cell empty"></div>`;
            }
            html += numStr.split('').map(d => `<div class="math-cell">${d}</div>`).join('');
            return html;
        }

        // --- Problem Generation Functions ---

        function generateAdditionProblem() {
            currentOperation = 'addition';
            currentProblemChecked = false;
            clearFeedback();

            num1 = getRandomInt(10, 999); // 2 or 3 digits
            num2 = getRandomInt(10, 999); // 2 or 3 digits

            const num1Str = num1.toString();
            const num2Str = num2.toString();
            const maxLen = Math.max(num1Str.length, num2Str.length);
            const resultLen = Math.max(maxLen, (num1 + num2).toString().length); // Max length for result, including potential carry

            let html = '';

            // Memory (Carry) row - aligned with result length
            html += '<div class="math-row">';
            // Add an empty cell for the operator column
            html += `<div class="math-cell empty"></div>`;
            for (let i = 0; i < resultLen; i++) {
                html += `<input type="number" class="math-input" id="mem-add-${i}" placeholder="↑" maxlength="1" />`;
            }
            html += '</div>';

            // First number
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            html += padNumberForDisplay(num1Str, maxLen);
            html += '</div>';

            // Second number with operator
            html += '<div class="math-row">';
            html += `<div class="math-cell">+</div>`;
            html += padNumberForDisplay(num2Str, maxLen);
            html += '</div>';

            // Separator line
            html += '<div class="math-row">';
            for (let i = 0; i < maxLen + 1; i++) { // +1 for operator space
                html += '<div class="math-cell separator-line"></div>';
            }
            html += '</div>';

            // Answer inputs
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            for (let i = 0; i < resultLen; i++) {
                html += `<input type="number" class="math-input" id="ans-${i}" maxlength="1" />`;
            }
            html += '</div>';

            mathProblemContainer.innerHTML = html;
            document.getElementById('ans-0').focus(); // Focus on first input
        }

        function generateSubtractionProblem() {
            currentOperation = 'subtraction';
            currentProblemChecked = false;
            clearFeedback();

            // Ensure num1 is larger than num2 for positive result
            num1 = getRandomInt(100, 999); // 3 digits
            num2 = getRandomInt(10, num1 - 10); // 2 or 3 digits, smaller than num1

            const num1Str = num1.toString();
            const num2Str = num2.toString();
            const maxLen = Math.max(num1Str.length, num2Str.length);

            let html = '';

            // Memory (Borrow) row
            html += '<div class="math-row">';
            // Add an empty cell for the operator column
            html += `<div class="math-cell empty"></div>`;
            for (let i = 0; i < maxLen; i++) {
                html += `<input type="number" class="math-input" id="mem-sub-${i}" placeholder="↓" maxlength="1" />`;
            }
            html += '</div>';

            // First number
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            html += padNumberForDisplay(num1Str, maxLen);
            html += '</div>';

            // Second number with operator
            html += '<div class="math-row">';
            html += `<div class="math-cell">-</div>`;
            html += padNumberForDisplay(num2Str, maxLen);
            html += '</div>';

            // Separator line
            html += '<div class="math-row">';
            for (let i = 0; i < maxLen + 1; i++) { // +1 for operator space
                html += '<div class="math-cell separator-line"></div>';
            }
            html += '</div>';

            // Answer inputs
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            for (let i = 0; i < maxLen; i++) {
                html += `<input type="number" class="math-input" id="ans-${i}" maxlength="1" />`;
            }
            html += '</div>';

            mathProblemContainer.innerHTML = html;
            document.getElementById('ans-0').focus(); // Focus on first input
        }

        function generateMultiplicationProblem() {
            currentOperation = 'multiplication';
            currentProblemChecked = false;
            clearFeedback();

            const multiplicandDigits = getRandomInt(2, 3);
            const multiplierDigits = getRandomInt(1, 3); // Multiplier can be 1 or 2 digits

            num1 = getRandomInt(Math.pow(10, multiplicandDigits - 1), Math.pow(10, multiplicandDigits) - 1);
            num2 = getRandomInt(Math.pow(10, multiplierDigits - 1), Math.pow(10, multiplierDigits) - 1);

            const num1Str = num1.toString();
            const num2Str = num2.toString();
            const maxLength = num1Str.length + num2Str.length; // Max length for final product

            let html = '';

            // Carry row (for partial products)
            html += '<div class="math-row">';
            // Add an empty cell for the operator column
            html += `<div class="math-cell empty"></div>`;
            for (let i = 0; i < maxLength; i++) {
                html += `<input type="number" class="math-input" id="carry-${i}" placeholder="↑" maxlength="1" />`;
            }
            html += '</div>';

            // Multiplicand
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            html += padNumberForDisplay(num1Str, maxLength - 1); // -1 for operator space
            html += '</div>';

            // Multiplier
            html += '<div class="math-row">';
            html += `<div class="math-cell">×</div>`;
            html += padNumberForDisplay(num2Str, maxLength - 1);
            html += '</div>';

            // Separator line
            html += '<div class="math-row">';
            for (let i = 0; i < maxLength + 1; i++) { // +1 for operator space
                html += '<div class="math-cell separator-line"></div>';
            }
            html += '</div>';

            expectedPartialRows = [];
            const bottomDigits = num2Str.split('').map(Number);
            const topDigits = num1Str.split('').map(Number);

            for (let i = bottomDigits.length - 1; i >= 0; i--) {
                let carry = 0;
                const row = [];
                for (let j = topDigits.length - 1; j >= 0; j--) {
                    const prod = bottomDigits[i] * topDigits[j] + carry;
                    row.unshift(prod % 10);
                    carry = Math.floor(prod / 10);
                }
                if (carry > 0) row.unshift(carry);
                expectedPartialRows.push({ row, shift: bottomDigits.length - 1 - i });
            }

            // Partial product rows
            for (let r = 0; r < expectedPartialRows.length; r++) {
                html += '<div class="math-row">';
                // Add an empty cell for the operator column
                html += `<div class="math-cell empty"></div>`;
                const { row, shift } = expectedPartialRows[r];
                const leadingPadding = maxLength - row.length - shift;
                for (let i = 0; i < leadingPadding; i++) html += `<div class="math-cell empty"></div>`;
                for (let i = 0; i < row.length; i++) {
                    html += `<input type="number" class="math-input" id="p${r}-${i}" maxlength="1" />`;
                }
                for (let z = 0; z < shift; z++) {
                    html += `<input type="number" class="math-input" value="0" disabled />`;
                }
                html += '</div>';
            }

            // Final separator line
            html += '<div class="math-row">';
            for (let i = 0; i < maxLength + 1; i++) { // +1 for operator space
                html += '<div class="math-cell separator-line"></div>';
            }
            html += '</div>';

            // Final answer row
            html += '<div class="math-row">';
            html += `<div class="math-cell empty"></div>`; // Space for operator
            for (let i = 0; i < maxLength; i++) {
                html += `<input type="number" class="math-input" id="ans-${i}" maxlength="1" />`;
            }
            html += '</div>';

            mathProblemContainer.innerHTML = html;
            document.getElementById('p0-0').focus(); // Focus on first partial product input
        }


        function generateDivisionProblem() {
            currentOperation = 'division';
            currentProblemChecked = false;
            clearFeedback();

            let divisor;
            let dividend;
            let quotient;
            let remainder;

            // Generate a problem with a 3-digit dividend and 1-digit divisor
            do {
                divisor = getRandomInt(2, 9); // Single digit divisor
                // Ensure dividend is 3 digits (100-999)
                dividend = getRandomInt(100, 999);
                quotient = Math.floor(dividend / divisor);
                remainder = dividend % divisor;
            } while (quotient < 10); // Ensure quotient is at least 2 digits for multiple steps

            num1 = dividend; // Dividend
            num2 = divisor; // Divisor

            const dividendStr = num1.toString();
            const divisorStr = num2.toString();
            const actualQuotientStr = Math.floor(num1 / num2).toString();

            // Max width for alignment, based on dividend length (always 3 for 3-digit dividend)
            const maxProblemWidth = dividendStr.length; // Will be 3
            const cellWidth = 46; // 45px width + 1px margin

            let html = '';
            html += '<div class="long-division-container">';

            // --- Quotient input row ---
            html += '<div class="division-quotient-row">';
            // Spacer for divisor area (50px width + 5px padding-right = 55px)
            html += `<div class="math-cell empty" style="width: 55px;"></div>`;

            // Quotient input boxes (always maxProblemWidth for 3-digit dividend)
            for (let i = 0; i < maxProblemWidth; i++) {
                html += `<input type="number" class="math-input quotient-digit-input" id="q-${i}" maxlength="1" />`;
            }
            html += `</div>`; // End division-quotient-row

            // --- Main division line and numbers ---
            html += '<div class="division-problem-line">';
            // Dynamically set the width and left position of the line
            const lineLeft = 55; // Divisor width + padding
            const lineWidth = maxProblemWidth * cellWidth; // Total width of dividend cells
            html += `<style>.division-problem-line::before { left: ${lineLeft}px; width: ${lineWidth}px; }</style>`;

            html += `<div class="division-divisor-display">${divisorStr}</div>`;
            html += `<div class="division-dividend-display">`;
            html += dividendStr.split('').map(d => `<div class="math-cell">${d}</div>`).join('');
            html += `</div>`;
            html += '</div>'; // End division-problem-line

            // --- Dynamic Steps ---
            let previousSubtractionResult = 0; // This will hold the remainder from the previous step

            for (let j = 0; j < maxProblemWidth; j++) { // Iterate through each digit of the dividend (0, 1, 2 for 3-digit)
                let currentDigit = parseInt(dividendStr[j]);
                
                // Build the current partial dividend based on previous remainder and current digit
                let currentPartialDividend;
                if (j === 0) {
                    currentPartialDividend = currentDigit;
                } else {
                    currentPartialDividend = parseInt(previousSubtractionResult.toString() + currentDigit.toString());
                }

                let qDigit = Math.floor(currentPartialDividend / num2);
                let product = qDigit * num2;
                let subtractionResult = currentPartialDividend - product;
                previousSubtractionResult = subtractionResult; // Store for the next iteration

                let productStr = product.toString();
                let subtractionResultStr = subtractionResult.toString();

                // Calculate the starting column for the product/subtraction result within the dividend's width
                // The rightmost digit of the product/subtraction should align with dividendStr[j]
                let startColumnForProduct = j - (productStr.length - 1);
                if (startColumnForProduct < 0) startColumnForProduct = 0; // Ensure it doesn't go negative

                let startColumnForSubResult = j - (subtractionResultStr.length - 1);
                if (startColumnForSubResult < 0) startColumnForSubResult = 0;

                // --- Product row (user fills this) ---
                html += '<div class="division-step-row">';
                // Spacer for divisor area (55px) + empty cells to align the product's first digit - 1 cell for minus sign
                html += `<div class="math-cell empty" style="width: ${55 + (startColumnForProduct * cellWidth) - cellWidth}px;"></div>`;
                html += `<div class="math-cell empty">-</div>`; // Minus sign
                for (let k = 0; k < productStr.length; k++) {
                    html += `<input type="number" class="math-input division-step-input" id="prod-${j}-${k}" maxlength="1" />`;
                }
                html += `</div>`;

                // --- Subtraction line ---
                html += '<div class="division-step-row subtraction-line"></div>';

                // --- Subtraction result row (user fills this) ---
                html += '<div class="division-step-row">';
                // Spacer for divisor area (55px) + empty cells to align the subtraction result's first digit
                html += `<div class="math-cell empty" style="width: ${55 + (startColumnForSubResult * cellWidth)}px;"></div>`;
                for (let k = 0; k < subtractionResultStr.length; k++) {
                    html += `<input type="number" class="math-input division-step-input" id="sub-${j}-${k}" maxlength="1" />`;
                }

                // Bring down next digit if available (only if not the last digit of the dividend)
                if (j < maxProblemWidth - 1) {
                    // The brought-down digit should appear in the column of dividendStr[j+1]
                    // Calculate empty cells needed to push it to that column from where subtractionResultStr ends
                    let endColumnOfSubResult = startColumnForSubResult + subtractionResultStr.length;
                    let cellsToPadBeforeBroughtDown = (j + 1) - endColumnOfSubResult;
                    
                    for (let k = 0; k < cellsToPadBeforeBroughtDown; k++) {
                        html += `<div class="math-cell empty"></div>`;
                    }
                    html += `<div class="math-cell division-cell-display brought-down-digit">${dividendStr[j + 1]}</div>`;
                }
                html += `</div>`;
            }

            // Final Remainder input
            html += '<div class="remainder-row">';
            // Align remainder input to the rightmost digit of the problem
            let remainderLeftMargin = 55 + (maxProblemWidth - remainder.toString().length) * cellWidth;
            html += `<div class="math-cell empty" style="width: ${remainderLeftMargin}px;"></div>`;
            html += `<label class="remainder-label" for="remainder-input">שארית:</label>`;
            html += `<input type="number" class="remainder-input" id="remainder-input" maxlength="2" />`;
            html += '</div>';

            mathProblemContainer.innerHTML = html;
            document.getElementById('q-0').focus();
        }


        // --- Answer Checking Functions ---

        function checkAnswer() {
            if (currentProblemChecked) return; // Prevent multiple scoring

            let isCorrect = true;

            if (currentOperation === 'addition') {
                const expectedSum = num1 + num2;
                const answerInputs = Array.from(document.querySelectorAll('[id^="ans-"]'));
                const userAnswerStr = answerInputs.map(input => input.value.trim() || '').join('');
                const fullAnswer = parseInt(userAnswerStr);

                if (fullAnswer === expectedSum) {
                    answerInputs.forEach(input => markInput(input, true));
                } else {
                    isCorrect = false;
                    answerInputs.forEach(input => markInput(input, false));
                }

                // Memory cells are NOT marked green/red
                const memInputs = Array.from(document.querySelectorAll('[id^="mem-add-"]'));
                memInputs.forEach(input => {
                    input.classList.remove('correct', 'incorrect'); // Ensure no marking
                });

            } else if (currentOperation === 'subtraction') {
                const expectedDifference = num1 - num2;
                const answerInputs = Array.from(document.querySelectorAll('[id^="ans-"]'));
                const userAnswerStr = answerInputs.map(input => input.value.trim() || '').join('');
                const fullAnswer = parseInt(userAnswerStr);

                if (fullAnswer === expectedDifference) {
                    answerInputs.forEach(input => markInput(input, true));
                } else {
                    isCorrect = false;
                    answerInputs.forEach(input => markInput(input, false));
                }

                // Memory cells are NOT marked green/red
                const memInputs = Array.from(document.querySelectorAll('[id^="mem-sub-"]'));
                memInputs.forEach(input => {
                    input.classList.remove('correct', 'incorrect'); // Ensure no marking
                });

            } else if (currentOperation === 'multiplication') {
                const expectedProduct = num1 * num2;
                const finalAnswerInputs = Array.from(document.querySelectorAll('[id^="ans-"]'));
                const finalUserAnswerStr = finalAnswerInputs.map(input => input.value.trim() || '0').join('');
                const finalUserAnswer = parseInt(finalUserAnswerStr);

                // Check partial products first
                expectedPartialRows.forEach((entry, rIdx) => {
                    const { row } = entry;
                    row.forEach((val, i) => {
                        const el = document.getElementById(`p${rIdx}-${i}`);
                        if (el) {
                            const inputVal = parseInt(el.value);
                            if (inputVal === val) {
                                markInput(el, true);
                            } else {
                                markInput(el, false);
                                isCorrect = false; // Partial product mistake
                            }
                        }
                    });
                });

                // Check final answer
                if (finalUserAnswer === expectedProduct) {
                    finalAnswerInputs.forEach(input => markInput(input, true));
                } else {
                    finalAnswerInputs.forEach(input => markInput(input, false));
                    isCorrect = false; // Final answer mistake
                }
                // Memory cells (carry-overs) are NOT marked green/red
                const memInputs = Array.from(document.querySelectorAll('[id^="carry-"]'));
                memInputs.forEach(input => {
                    input.classList.remove('correct', 'incorrect'); // Ensure no marking
                });

            } else if (currentOperation === 'division') {
                const actualQuotientStr = Math.floor(num1 / num2).toString();
                const expectedRemainder = num1 % num2;
                const maxProblemWidth = 3; // Fixed for 3-digit dividend

                // Check quotient digits
                const quotientInputs = Array.from(document.querySelectorAll('.quotient-digit-input'));
                for (let i = 0; i < quotientInputs.length; i++) {
                    const inputVal = quotientInputs[i].value.trim();
                    
                    // Determine the expected digit for this specific input box
                    let expectedDigitForInput;
                    if (i < (maxProblemWidth - actualQuotientStr.length)) {
                        // These are leading zero boxes if the quotient is shorter than maxProblemWidth
                        expectedDigitForInput = 0;
                    } else {
                        // These are the actual digits of the quotient
                        expectedDigitForInput = parseInt(actualQuotientStr[i - (maxProblemWidth - actualQuotientStr.length)]);
                    }

                    if (parseInt(inputVal) === expectedDigitForInput) {
                        markInput(quotientInputs[i], true);
                    } else {
                        markInput(quotientInputs[i], false);
                        isCorrect = false;
                    }
                }

                // Check remainder
                const remainderInput = document.getElementById('remainder-input');
                const userRemainder = parseInt(remainderInput.value.trim() || '0');
                if (userRemainder === expectedRemainder) {
                    markInput(remainderInput, true);
                } else {
                    markInput(remainderInput, false);
                    isCorrect = false;
                }

                // Check intermediate product and subtraction inputs
                const dividendStr = num1.toString();
                let previousSubtractionResult = 0; // Remainder from previous step

                // Re-calculate steps to validate user input
                for (let j = 0; j < maxProblemWidth; j++) {
                    let currentDigit = parseInt(dividendStr[j]);
                    let currentPartialDividend;
                    if (j === 0) {
                        currentPartialDividend = currentDigit;
                    } else {
                        currentPartialDividend = parseInt(previousSubtractionResult.toString() + currentDigit.toString());
                    }

                    let qDigit = Math.floor(currentPartialDividend / num2);
                    let product = qDigit * num2;
                    let subtractionResult = currentPartialDividend - product;
                    previousSubtractionResult = subtractionResult;

                    // Check product inputs
                    const prodInputs = Array.from(document.querySelectorAll(`[id^="prod-${j}-"]`));
                    const userProdStr = prodInputs.map(input => input.value.trim() || '').join('');
                    const userProduct = parseInt(userProdStr);

                    if (userProduct === product) {
                        prodInputs.forEach(input => markInput(input, true));
                    } else {
                        prodInputs.forEach(input => markInput(input, false));
                        isCorrect = false;
                    }

                    // Check subtraction inputs
                    const subInputs = Array.from(document.querySelectorAll(`[id^="sub-${j}-"]`));
                    const userSubStr = subInputs.map(input => input.value.trim() || '').join('');
                    const userSubtractionResult = parseInt(userSubStr);

                    if (userSubtractionResult === subtractionResult) {
                        subInputs.forEach(input => markInput(input, true));
                    } else {
                        subInputs.forEach(input => markInput(input, false));
                        isCorrect = false;
                    }
                }
            }

            if (isCorrect) {
                feedbackEl.textContent = '✅ נכון! כל הכבוד!';
                feedbackEl.classList.add('correct');
                feedbackEl.classList.remove('incorrect');
                score++;
                currentProblemChecked = true;
            } else {
                feedbackEl.textContent = `❌ לא מדויק. נסו שוב.`;
                feedbackEl.classList.add('incorrect');
                feedbackEl.classList.remove('correct');
                // Score is not reduced on mistake as per previous logic
            }
            updateScoreDisplay();
        }

        // --- Event Listeners ---
        document.getElementById('new-addition-button').addEventListener('click', generateAdditionProblem);
        document.getElementById('new-subtraction-button').addEventListener('click', generateSubtractionProblem);
        document.getElementById('new-multiplication-button').addEventListener('click', generateMultiplicationProblem);
        document.getElementById('new-division-button').addEventListener('click', generateDivisionProblem);
        checkAnswerButton.addEventListener('click', checkAnswer);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && e.target.classList.contains('math-input')) {
                e.preventDefault();
                const inputs = Array.from(document.querySelectorAll('.math-input'));
                const index = inputs.indexOf(e.target);
                if (index !== -1 && index + 1 < inputs.length) {
                    inputs[index + 1].focus();
                }
            } else if (e.key === 'Enter' && (e.target.classList.contains('quotient-digit-input') || e.target.classList.contains('division-step-input') || e.target.id === 'remainder-input')) {
                 e.preventDefault();
                 checkAnswer(); // Check answer immediately for division
            }
        });

        // Initial problem generation removed - user must select
        // document.addEventListener('DOMContentLoaded', generateMultiplicationProblem);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>תרגילי חשבון</title>
    <style>
        body {
            font-family: "Arial Hebrew", "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        h1 {
            color: #2e8b57;
            margin-bottom: 20px;
        }
        .game-container {
            margin-top: 20px;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls-top {
            display: flex;